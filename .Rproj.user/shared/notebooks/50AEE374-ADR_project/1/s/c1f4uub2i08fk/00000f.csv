"0","#| label: Code"
"0","#| include: false"
"0","#| echo: false"
"0",""
"0","library(quantreg)"
"0","library(ggplot2)"
"0","library(dplyr)"
"0","library(tidyr)"
"0","library(gridExtra)"
"0","library(kableExtra)"
"0","library(tibble)"
"0",""
"0","# Fixed settings"
"0","set.seed(666)"
"0","beta0 <- 5; beta1 <- 1.5; beta2 <- -1.0"
"0","n_sim <- 100"
"0","outlier_frac <- 0.02"
"0","outlier_shift <- 30"
"0","tau_levels <- c(0.025, 0.25, 0.5, 0.75, 0.975)"
"0",""
"0","# Simulation function"
"0","simulate_data <- function(n = 200, multivariate = FALSE, heterosk = FALSE) {"
"0","  x1 <- runif(n, 0, 10)"
"0","  x2 <- if (multivariate) runif(n, 0, 10) else rep(0, n)"
"0","  sd_e <- if (heterosk) (1 + 0.6*x1) else 2"
"0","  e <- rnorm(n, mean = 0, sd = sd_e)"
"0","  y <- beta0 + beta1 * x1 + beta2 * x2 + e"
"0","  data.frame(y = y, x1 = x1, x2 = x2) "
"0","}"
"0",""
"0","add_high_leverage_point <- function(data) {"
"0","  # Define a new x1 value far beyond the existing range"
"0","  new_x1 <- max(data$x1)"
"0","  new_x2 <- mean(data$x2) + 1  # Reasonable x2 value"
"0","  new_y <- max(data$y) * 20  # Extreme y value for high leverage"
"0",""
"0","  # Create a new data point"
"0","  new_point <- data.frame(y = new_y, x1 = new_x1, x2 = new_x2)"
"0",""
"0","  # Append it to the original dataset"
"0","  data_out <- rbind(data, new_point)"
"0","  return(data_out)"
"0","}"
"0",""
"0","# Fit models function"
"0","fit_models <- function(data, multivariate = FALSE) {"
"0","  if (multivariate) {"
"0","    ols <- lm(y ~ x1 + x2, data = data)"
"0","    qrs <- lapply(tau_levels, function(tau) rq(y ~ x1 + x2, tau = tau, data = data))"
"0","  } else {"
"0","    ols <- lm(y ~ x1, data = data)"
"0","    qrs <- lapply(tau_levels, function(tau) rq(y ~ x1, tau = tau, data = data))"
"0","  }"
"0","  list(ols = ols, qrs = qrs)"
"0","}"
"0","# Different scenarios"
"0",""
"0","multivariate_data = simulate_data(n=500, multivariate=TRUE, heterosk = TRUE)"
"0","multivariate_data_outlier = add_high_leverage_point(multivariate_data)"
"0",""
"0","scenarios <- list("
"0","  clean_multi = multivariate_data,"
"0","  outlier_multi = multivariate_data_outlier"
"0",")"
"0",""
"0","# Fit models"
"0","models <- list("
"0","  clean_multi = fit_models(scenarios$clean_multi, multivariate = TRUE),"
"0","  outlier_multi = fit_models(scenarios$outlier_multi, multivariate = TRUE)"
"0",")"
